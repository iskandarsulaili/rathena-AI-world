// P2P Host Node Configuration

// Node identity and basic settings
node: {
    // Node identification
    id: ""  // Will be assigned by coordinator
    name: "P2P-Host"
    type: "auto"  // "main_server", "player_host", or "auto" for dynamic role
    
    // Role settings
    role: {
        can_be_main: true  // Can this node act as main server
        can_be_player_host: true  // Can this node act as player host
        preferred_role: "auto"  // Preferred role if multiple roles possible
        max_hosted_maps: 3  // Reduced to ensure better performance per map
    }
    
    // Network settings
    network: {
        bind_ip: "0.0.0.0"
        port: 0  // Will be assigned by coordinator
        public_ip: ""  // Leave empty for auto-detection
        coordinator_address: "coordinator.example.com"
        coordinator_port: 5121
    }
    
    // Performance settings
    performance: {
        max_maps: 3
        max_players_per_map: 100
        base_player_limit: 100      // Base limit for dynamic scaling
        max_player_multiplier: 2.0  // Maximum multiplier based on performance
        player_bandwidth: 1.0       // Required bandwidth per player (Mbps)
        reserved_bandwidth: 10.0    // Reserved bandwidth for system (Mbps)
        update_interval: 33  // ms (approx 30 fps)
    }
}

// Resource management
resources: {
    // CPU settings
    cpu: {
        max_usage: 80  // percentage
        reserved_cores: 1
        min_free_cpu: 30  // percentage, increased for better stability
        process_priority: "normal"  // low, normal, high
        metrics: {
            collect_model_info: true
            collect_frequency: true
            collect_cache_info: true
            collect_load_avg: true
            benchmark_interval: 3600  // seconds
        }
    }
    
    // Memory settings
    memory: {
        max_usage: 80  // percentage, reduced for better stability
        min_free: 2048  // MB, increased to match new requirements
        min_available: 4096  // MB, increased to match new requirements
        swap_threshold: 90  // percentage
        pressure_monitoring: true
        metrics: {
            collect_detailed_stats: true
            monitor_pressure: true
            track_page_faults: true
            track_cached_ram: true
        }
    }
    
    // Network settings
    network: {
        max_bandwidth: 90  // Mbps (leaving 10% overhead)
        buffer_size: 65536
        max_connections: 1000
        min_bandwidth_in: 100     // Minimum incoming bandwidth required (Mbps)
        min_bandwidth_out: 50      // Minimum outgoing bandwidth required (Mbps)
        quality_monitoring: {
            enabled: true
            measure_upload_speed: true
            measure_download_speed: true
            measure_latency: true
            measure_jitter: true
            max_latency: 50       // Maximum acceptable latency (ms)
            max_jitter: 20        // Maximum acceptable jitter (ms)
            measure_packet_loss: true
            max_packet_loss: 1.0  // Maximum acceptable packet loss (%)
            test_interval: 30     // seconds, increased monitoring frequency
            test_duration: 5      // seconds, shorter but more frequent tests
            ddos_protection: {
                enabled: true
                connection_threshold: 500    // Max new connections per second
                packet_threshold: 10000      // Max packets per second
                burst_limit: 50             // Max concurrent new connections
                detection_window: 10        // Detection window in seconds
                blacklist_duration: 3600    // Blacklist duration in seconds
            }
        }
    }
}

// State management
state: {
    // State synchronization
    sync: {
        enabled: true
        interval: 1000  // ms, more frequent sync for better consistency
        verify_consistency: true
        full_sync_interval: 30000  // ms, more frequent full sync
    }
    
    // State backup
    backup: {
        enabled: true
        interval: 60   // seconds, more frequent backups
        keep_versions: 5  // keep more versions for safety
        compression: true
        verify_backup: true  // always verify backups
    }
    
    // State transfer
    transfer: {
        chunk_size: 1048576  // 1MB
        parallel_transfers: 2
        compression: true
        verify_transfer: true
    }
}

// Failover handling
failover: {
    // Role transition
    transition: {
        enabled: true
        allow_main_server_role: true
        allow_player_host_role: true
        transition_timeout: 10  // seconds, faster transitions
        round_robin: {
            enabled: true           // Enable round-robin restoration
            check_interval: 30      // Check interval in seconds
            min_stable_time: 300    // Minimum time before role change
        }
    }
    
    // State preservation
    state: {
        save_interval: 1000  // ms, more frequent saves
        max_state_age: 30  // seconds, reduced for fresher state
        require_consistency: true
    }
    
    // Recovery
    recovery: {
        auto_recover: true
        max_attempts: 3
        backoff_interval: 2000  // ms, faster recovery attempts
        max_recovery_time: 60   // Maximum recovery time in seconds
        failover_delay: 10      // Delay before failover in seconds
    }
}

// Monitoring and metrics
monitoring: {
    // System metrics
    system_metrics: {
        enabled: true
        collection_interval: 1000  // ms, more frequent collection
        report_interval: 30000  // ms
        detailed_logging: true
        collectors: {
            hardware_info: true
            performance_stats: true
            network_stats: true
            state_metrics: true
        }
    }
    
    // Role monitoring
    role_metrics: {
        track_transitions: true
        log_state_changes: true
        measure_availability: true
        record_hosting_stats: true
    }
    
    // Health checks
    health: {
        enabled: true
        check_interval: 1000  // ms, more frequent health checks
        failure_threshold: 3
        success_threshold: 2
        timeout: 1000  // ms
    }
}

// Security settings
security: {
    // Encryption
    encryption: {
        enabled: true
        method: "AES-256-GCM"
        key_rotation: true
        rotation_interval: 3600  // seconds
    }
    
    // Authentication
    auth: {
        require_auth: true
        token_validity: 3600  // seconds
        verify_peers: true
        secure_state_transfer: true
    }
}

// Debug settings
debug: {
    // Logging
    logging: {
        level: "info"  // debug, info, warn, error
        file: "log/p2p_host.log"
        max_size: 100  // MB
        max_files: 10
        log_transitions: true
    }
    
    // Development
    development: {
        local_mode: false
        mock_coordinator: false
        simulate_failures: false
    }
}